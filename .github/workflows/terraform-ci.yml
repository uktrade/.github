# .github/workflows/terraform-ci.yml
name: terraform-ci
on:
  workflow_call:

jobs:
  terraform-ci:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      TF_IN_AUTOMATION: "true"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: FMT (repo-wide)
        run: terraform fmt -recursive -check

      - name: Validate (per dir with .tf)
        shell: bash
        run: |
          set -euo pipefail
          # Find unique directories that contain .tf files (excluding .terraform dirs)
          mapfile -t DIRS < <(git ls-files '*.tf' | xargs -n1 dirname | sort -u | grep -v '\.terraform' || true)

          if [[ ${#DIRS[@]} -eq 0 ]]; then
            echo "No Terraform files found. Skipping validation."
            exit 0
          fi

          for d in "${DIRS[@]}"; do
            echo "==> terraform validate: $d"
            pushd "$d" >/dev/null
            # Safe init: no backend, no prompts, donâ€™t write/modify lockfile
            terraform init -backend=false -input=false -lockfile=readonly -no-color || true
            terraform validate -no-color || (echo "::error file=$d::terraform validate failed" && exit 1)
            popd >/dev/null
          done

      # -----------------------------------------------------------------------------
      # TFLint is currently not approved. Leaving a ready-to-enable block below.
      # To enable later:
      #  - Add a .tflint.hcl at repo root OR fetch a central one and pass -c
      #  - Uncomment this step and (optionally) add actions/cache for plugins
      # -----------------------------------------------------------------------------
      # - name: Install TFLint
      #   run: |
      #     curl -sL https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
      #
      # - name: TFLint (per dir)
      #   shell: bash
      #   run: |
      #     set -euo pipefail
      #     mapfile -t DIRS < <(git ls-files '*.tf' | xargs -n1 dirname | sort -u | grep -v '\.terraform' || true)
      #     if [[ ${#DIRS[@]} -eq 0 ]]; then
      #       echo "No Terraform files found. Skipping tflint."
      #       exit 0
      #     fi
      #     for d in "${DIRS[@]}"; do
      #       echo "==> tflint $d"
      #       (cd "$d" && tflint --init && tflint)
      #     done
