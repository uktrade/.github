# .github/workflows/terraform-ci.yml
name: terraform-ci

on:
  workflow_call:
    inputs:
      validate_only_roots:
        description: "Override auto-discovery with explicit roots (newline-separated)."
        required: false
        type: string
        default: ""
      run_tflint:
        description: "Run TFLint after fmt/validate."
        required: false
        type: boolean
        default: false

  pull_request: 
    types:
      - edited
      - opened
      - reopened

    branches:
      - main
      - master
      - dev

jobs:
  terraform-ci:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      TF_IN_AUTOMATION: "true"
      TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache
      TF_CI_DEBUG: "false"  # set to "true" in the caller to see extra local-module debug

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Prepare Terraform plugin cache dir
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.terraform.d/plugin-cache"

      - name: Cache Terraform plugins
        uses: actions/cache@v4
        with:
          path: ~/.terraform.d/plugin-cache
          key: tf-plugins-${{ runner.os }}-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: |
            tf-plugins-${{ runner.os }}-

      - name: FMT (repo-wide)
        run: terraform fmt -recursive -check

      - name: Validate (per dir with .tf, skip examples/tests/.github and broken local module refs)
        shell: bash
        run: |
          set -euo pipefail

          # Build list of candidate dirs
          if [[ -n "${{ inputs.validate_only_roots }}" ]]; then
            mapfile -t DIRS < <(printf "%s\n" "${{ inputs.validate_only_roots }}" | sed '/^\s*$/d')
          else
            mapfile -t DIRS < <(git ls-files '*.tf' | xargs -n1 dirname | sort -u | grep -v '\.terraform' || true)
          fi

          if [[ ${#DIRS[@]} -eq 0 ]]; then
            echo "No Terraform files found. Skipping validation."
            exit 0
          fi

          has_missing_local_module() {
            local dir="$1" missing=0

            # Optional debug
            if [[ "${TF_CI_DEBUG:-false}" == "true" ]]; then
              echo ">> DEBUG: scanning only '$dir' (non-recursive) for local module sources"
            fi

            # Non-recursive scan: only consider *.tf files directly inside $dir
            while IFS= read -r src; do
              # Only consider *true* local paths that begin with ./ or ../
              if [[ "$src" =~ ^(\.\/|\.\.\/) ]]; then
                local path="$dir/$src"
                if [[ ! -e "$path" ]]; then
                  echo ">> Note: $dir expects local module '$src' (missing at: $path)"
                  missing=1
                fi
              fi
            done < <(
              find "$dir" -maxdepth 1 -type f -name '*.tf' -print0 2>/dev/null \
                | xargs -0 grep -hE '^[[:space:]]*source[[:space:]]*=[[:space:]]*"([^"]+)"' 2>/dev/null \
                | sed -E 's/.*source[[:space:]]*=[[:space:]]*"([^"]+)".*/\1/' \
                | sort -u || true
            )

            return $missing
          }

          any_validated=0
          for d in "${DIRS[@]}"; do
            # Skip noisy locations
            if [[ "$d" =~ (^|/)(examples?|test|tests|\.github)(/|$) ]]; then
              echo ">> Skipping $d (examples/tests/.github)"
              continue
            fi

            # Gate on resolvable local modules only (non-recursive check)
            if has_missing_local_module "$d"; then
              echo ">> Skipping $d (unresolvable local module paths)"
              continue
            fi

            echo "==> terraform validate: $d"
            pushd "$d" >/dev/null

            # Lightweight init: no backend, no interactive input, respect lockfile
            terraform init -backend=false -input=false -lockfile=readonly -no-color || true

            terraform validate -no-color || { echo "::error file=$d::terraform validate failed"; exit 1; }
            popd >/dev/null
            any_validated=1
          done

          if [[ "$any_validated" -eq 0 ]]; then
            echo "No eligible Terraform roots to validate (all skipped)."
          fi

      - name: Setup TFLint
        if: ${{ inputs.run_tflint }}
        uses: terraform-linters/setup-tflint@v4

      - name: Cache TFLint plugins
        if: ${{ inputs.run_tflint }}
        uses: actions/cache@v4
        with:
          path: ~/.tflint.d/plugins
          key: tflint-plugins-${{ runner.os }}-${{ hashFiles('**/.tflint.hcl') }}
          restore-keys: |
            tflint-plugins-${{ runner.os }}-

      - name: TFLint (per dir)
        if: ${{ inputs.run_tflint }}
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t DIRS < <(git ls-files '*.tf' | xargs -n1 dirname | sort -u | grep -v '\.terraform' || true)
          if [[ ${#DIRS[@]} -eq 0 ]]; then
            echo "No Terraform files found. Skipping tflint."
            exit 0
          fi
          for d in "${DIRS[@]}"; do
            echo "==> tflint $d"
            (cd "$d" && tflint --init && tflint)
          done
