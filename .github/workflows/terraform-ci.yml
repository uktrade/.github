# .github/workflows/terraform-ci.yml
name: terraform-ci

on:
  workflow_call:
    inputs:
      validate_only_roots:
        description: "Newline-separated list of terraform roots (e.g. '.', 'envs/dev', 'envs/prod'). If empty, validates only '.'"
        required: false
        type: string
        default: ""
      run_tflint:
        description: "Run TFLint after fmt/validate."
        required: false
        type: boolean
        default: false

  # Optional: allow running directly on PRs if marked as a Required Workflow
  pull_request:
    types: [opened, edited, reopened, synchronize]
    branches: [main, master, dev]

jobs:
  terraform-ci:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      TF_IN_AUTOMATION: "true"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

  
      - name: FMT (repo-wide)
        env:
          TF_PLUGIN_CACHE_DIR: ""
        run: terraform fmt -recursive -check
      # Configure provider cache only for init/validate (optional but fast)
      - name: Prepare Terraform plugin cache
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.terraform.d/plugin-cache"
          echo "TF_PLUGIN_CACHE_DIR=$HOME/.terraform.d/plugin-cache" >> "$GITHUB_ENV"

      - name: Cache Terraform provider plugins
        uses: actions/cache@v4
        with:
          path: ${{ env.HOME }}/.terraform.d/plugin-cache
          key: tf-plugins-${{ runner.os }}-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: |
            tf-plugins-${{ runner.os }}-

      - name: Validate (simple, explicit roots)
        shell: bash
        run: |
          set -euo pipefail

          if [[ -n "${{ inputs.validate_only_roots }}" ]]; then
            # newline-separated list to bash array
            mapfile -t DIRS < <(printf "%s\n" "${{ inputs.validate_only_roots }}" | sed '/^\s*$/d')
          else
            DIRS=(.)
          fi

          for d in "${DIRS[@]}"; do
            echo "==> terraform validate: $d"

            # Only enforce readonly lockfile if it exists
            lockflag=()
            [[ -f "$d/.terraform.lock.hcl" ]] && lockflag=(-lockfile=readonly)

            terraform -chdir="$d" init -backend=false -input=false "${lockflag[@]}" -no-color

            # Capture output
            if ! out="$(terraform -chdir="$d" validate -no-color 2>&1)"; then
              printf '%s\n' "$out"
              echo "::error file=$d::terraform validate failed"
              exit 1
            fi
          done

      - name: Setup TFLint
        if: ${{ inputs.run_tflint }}
        uses: terraform-linters/setup-tflint@v4

      - name: Cache TFLint plugins
        if: ${{ inputs.run_tflint }}
        uses: actions/cache@v4
        with:
          path: ~/.tflint.d/plugins
          key: tflint-plugins-${{ runner.os }}-${{ hashFiles('**/.tflint.hcl') }}
          restore-keys: |
            tflint-plugins-${{ runner.os }}-

      - name: TFLint (explicit roots; defaults to '.')
        if: ${{ inputs.run_tflint }}
        shell: bash
        run: |
          set -euo pipefail
          if [[ -n "${{ inputs.validate_only_roots }}" ]]; then
            mapfile -t DIRS < <(printf "%s\n" "${{ inputs.validate_only_roots }}" | sed '/^\s*$/d')
          else
            DIRS=(.)
          fi

          for d in "${DIRS[@]}"; do
            echo "==> tflint $d"
            (cd "$d" && tflint --init && tflint)
          done
