name: repo-metadata
on:
  workflow_call: {}

jobs:
  codeowners:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify CODEOWNERS exists and contains SRE team
        shell: bash
        run: |
          set -euo pipefail
          FILE=""
          if [[ -f ".github/CODEOWNERS" ]]; then FILE=".github/CODEOWNERS"; fi
          if [[ -z "$FILE" && -f "CODEOWNERS" ]]; then FILE="CODEOWNERS"; fi

          if [[ -z "$FILE" ]]; then
            echo "::error title=Missing CODEOWNERS::No CODEOWNERS file found (.github/CODEOWNERS or CODEOWNERS)."
            exit 1
          fi

          # Require your canonical team on the catch-all line
          if ! grep -Eq '^\s*\*\s+@uktrade/SRE-Owners(\s|$)' "$FILE"; then
            echo "::error title=Invalid CODEOWNERS::The '*' rule must include @uktrade/SRE-Owners."
            echo "Example:  *  @uktrade/SRE-Owners"
            exit 1
          fi

          echo "CODEOWNERS present and contains required team."
