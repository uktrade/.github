name: semver-guard
on:
  push:
    tags:
      - "v*"

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Validate tag format (SemVer 2.0.0)
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"

          # Strict SemVer2 regex (allows pre-release/build metadata)
          RX='^v?(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(?:-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(?:\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$'
          if [[ ! "$TAG" =~ $RX ]]; then
            echo "::error::Tag '$TAG' is not valid SemVer (expected vMAJOR.MINOR.PATCH, optional -prerelease/+build)."
            exit 1
          fi

      - name: Check monotonic increase vs latest
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          # Get previous tag (if any)
          PREV=$(git ls-remote --tags origin | awk '{print $2}' | sed 's|refs/tags/||' | grep -E '^v[0-9]+(\.[0-9]+){2}' | sed 's/\^{}//' | sort -V | tail -n1 || true)
          echo "Previous: ${PREV:-<none>}  New: $TAG"
          [[ -z "${PREV:-}" ]] && exit 0
          if [[ "$(printf "%s\n%s\n" "$PREV" "$TAG" | sort -V | tail -n1)" != "$TAG" ]]; then
            echo "::error::New tag '$TAG' is not greater than previous '$PREV'."
            exit 1
          fi
